---
- name: Install Orchestrator Infrastructure
  ansible.builtin.shell: |
    helm repo add redhat-developer {{ ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_infra_repo }}
    helm install my-orchestrator-infra redhat-developer/redhat-developer-hub-orchestrator-infra --version {{
    ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_infra_version }} \
    --set-string=serverlessLogicOperator.subscription.spec.installPlanApproval=Automatic \
    --set-string=serverlessOperator.subscription.spec.installPlanApproval=Automatic

- name: Wait for SonataFlow CRD to be created
  shell: |
    oc get crd sonataflows.sonataflow.org
  register: crd_result
  retries: 100
  delay: 10
  until: crd_result is not failed

- name: Install Orchestrator workflow repository
  ansible.builtin.shell: |
    helm repo add orchestrator-workflows {{ ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_workflows.repo }}

- name: Install Orchestrator workflows
  ansible.builtin.shell: |
    helm install {{ item.name }} {{ item.location }} {{
    item.customParameters }} -n {{
    ocp4_workload_redhat_developer_hub_bootstrap_backstage_namespace }}
  loop: "{{ ocp4_workload_redhat_developer_hub_bootstrap_orchestrator_workflows.chart }}"
  register: r_orch_workflow
  until: r_orch_workflow is not failed
  retries: 120
  delay: 10